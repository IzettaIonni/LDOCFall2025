name: Execute Ansible on Control Node

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # 1. Prepare the SSH Key for the Control Node
      - name: ðŸ”‘ Set up SSH Private Key
        run: |
          mkdir -p ~/.ssh/
          
          echo "${{ secrets.ANSIBLE_CONTROL_NODE_PRIVATE_KEY }}" > /tmp/ansible_ssh_key
          chmod 600 /tmp/ansible_ssh_key
          
          eval $(ssh-agent -s)
          ssh-add /tmp/ansible_ssh_key
          
          ssh-keyscan -H 34.116.171.246 >> ~/.ssh/known_hosts 
          
      # 2. Define Variables
      - name: ðŸ“ Set Environment Variables
        run: |
          # Replace with your actual control node details
          echo "CONTROL_NODE_USER=istize17" >> $GITHUB_ENV
          echo "CONTROL_NODE_IP=34.116.171.246" >> $GITHUB_ENV
          echo "REMOTE_PATH=/home/istize17/ansible_mealie" >> $GITHUB_ENV
          
      # 3. Transfer ONLY the Playbook and Inventory to the Control Node
      - name: ðŸ“‚ Transfer Playbook and Inventory to Control Node
        run: |
          SSH_COMMAND="ssh -i ~/.ssh/control_node_key ${{ env.CONTROL_NODE_USER }}@${{ env.CONTROL_NODE_IP }}"
          
          $SSH_COMMAND "mkdir -p ${{ env.REMOTE_PATH }}"
          
          echo "Copying playbook.yaml..."
          scp -i ~/.ssh/control_node_key \
            ./LDOCsys5/playbook.yaml \
            ${{ env.CONTROL_NODE_USER }}@${{ env.CONTROL_NODE_IP }}:${{ env.REMOTE_PATH }}/playbook.yaml
            
          echo "Copying inventory.ini..."
          scp -i ~/.ssh/control_node_key \
            ./LDOCsys5/inventory.ini \
            ${{ env.CONTROL_NODE_USER }}@${{ env.CONTROL_NODE_IP }}:${{ env.REMOTE_PATH }}/inventory_githubflow.ini
            
      # 4. Execute the Playbook on the Control Node via SSH
      - name: ðŸš€ Execute Playbook on Control Node
        run: |
          ssh -i ~/.ssh/control_node_key ${{ env.CONTROL_NODE_USER }}@${{ env.CONTROL_NODE_IP }} << EOF
          
          cd ${{ env.REMOTE_PATH }}
          
          ansible-playbook -i inventory.ini playbook.yaml
          
          EOF